# v0.3 開發計劃

**版本**: v0.3
**開始日期**: 2025-10-16
**狀態**: 🎯 計劃中

---

## 🎯 目標

1. **檔案路徑更自由** - 支援任意子資料夾結構
2. **改用 SVG 格式** - Kroki 輸出 SVG 而非 PNG（向量圖、覆蓋率高）
3. **支援更多圖表類型** - 擴展 Kroki 圖表類型支援

## 🔑 核心改變：SVG 優先

### 為什麼改用 SVG？

**問題：PNG 限制**
- ❌ D2 不支援 PNG（只有 SVG）
- ❌ BPMN 不支援 PNG（只有 SVG）
- ❌ Excalidraw 不支援 PNG（只有 SVG）
- ❌ PNG 是點陣圖，放大會模糊

**解決：SVG 優勢**
- ✅ 支援最廣泛（幾乎所有 Kroki 圖表都支援）
- ✅ 向量圖，無限縮放不失真
- ✅ 檔案更小
- ✅ Markdown 完全支援
- ✅ 可以複製文字內容

### HTTP 響應變化

**v0.1 (舊):**
```http
GET /demo/livedoc/dynamic/demo.puml
→ Content-Type: image/png
→ PNG 圖片
```

**v0.3 (新):**
```http
GET /demo/livedoc/architecture/system.d2
→ Content-Type: image/svg+xml
→ SVG 圖片
```

---

## 📋 功能清單

### 1. 檔案路徑自由化

**從：**
```
固定結構：
livedoc/static/{file}
livedoc/dynamic/{file}

URL: /{project}/livedoc/{static|dynamic}/{file}
```

**到：**
```
自由結構：
livedoc/{任意路徑}/{file}

URL: /{project}/livedoc/{任意路徑}/{file}
```

**範例：**
```
livedoc/
├── architecture/
│   ├── system.puml
│   ├── database.puml
│   └── logo.png
├── diagrams/
│   ├── flowchart.mmd
│   ├── sequence.d2
│   └── erd.erd
└── monitoring/
    └── waveform.wavedrom
```

### 2. 擴展 Kroki 圖表支援

**v0.1 已支援：**
- PlantUML (.puml)
- Mermaid (.mmd)

**v0.3 新增支援（基於 Kroki）：**

**架構圖類：**
- `.d2` - D2 diagrams
- `.c4` - C4 with PlantUML
- `.structurizr` - Structurizr

**流程圖類：**
- `.bpmn` - BPMN
- `.nomnoml` - Nomnoml
- `.graphviz` / `.dot` - GraphViz

**數據圖類：**
- `.vega` - Vega
- `.vegalite` - Vega-Lite
- `.ditaa` - Ditaa

**專業圖類：**
- `.erd` - Entity Relationship Diagrams
- `.dbml` - DBML (Database Markup Language)
- `.wavedrom` - WaveDrom (時序圖)
- `.pikchr` - Pikchr
- `.wireviz` - WireViz (接線圖)

**網路/系統圖：**
- `.nwdiag` - Network diagrams
- `.rackdiag` - Rack diagrams
- `.packetdiag` - Packet diagrams
- `.seqdiag` - Sequence diagrams (另一種格式)
- `.actdiag` - Activity diagrams
- `.blockdiag` - Block diagrams

**其他：**
- `.bytefield` - Bytefield
- `.excalidraw` - Excalidraw
- `.svgbob` - Svgbob
- `.tikz` - TikZ

---

## 🔧 技術實作

### 1. Router 修改

**舊邏輯：**
```javascript
app.get('/:project/livedoc/:type/:filename', ...)
// type 必須是 'static' 或 'dynamic'
```

**新邏輯：**
```javascript
app.get('/:project/livedoc/*', ...)
// * 匹配任意路徑
// 根據副檔名判斷處理方式
```

### 2. 副檔名映射表

```javascript
const EXTENSION_HANDLERS = {
  // 靜態圖片
  '.png': 'static',
  '.jpg': 'static',
  '.jpeg': 'static',
  '.gif': 'static',
  '.svg': 'static',

  // Kroki 動態圖表
  '.puml': 'plantuml',
  '.mmd': 'mermaid',
  '.d2': 'd2',
  '.c4': 'c4plantuml',
  '.structurizr': 'structurizr',
  '.bpmn': 'bpmn',
  '.nomnoml': 'nomnoml',
  '.dot': 'graphviz',
  '.graphviz': 'graphviz',
  '.vega': 'vega',
  '.vegalite': 'vegalite',
  '.ditaa': 'ditaa',
  '.erd': 'erd',
  '.dbml': 'dbml',
  '.wavedrom': 'wavedrom',
  '.pikchr': 'pikchr',
  '.wireviz': 'wireviz',
  '.nwdiag': 'nwdiag',
  '.rackdiag': 'rackdiag',
  '.packetdiag': 'packetdiag',
  '.seqdiag': 'seqdiag',
  '.actdiag': 'actdiag',
  '.blockdiag': 'blockdiag',
  '.bytefield': 'bytefield',
  '.excalidraw': 'excalidraw',
  '.svgbob': 'svgbob',
  '.tikz': 'tikz'
};
```

### 3. 向後兼容

確保舊的 URL 仍然可用：
```
✅ http://localhost:3000/demo/livedoc/static/test.png
✅ http://localhost:3000/demo/livedoc/dynamic/demo.puml
✅ http://localhost:3000/demo/livedoc/architecture/system.puml (新)
```

---

## 🧪 測試文件

### 測試目錄結構
```
demo/livedoc/
├── static/           # 舊格式（向後兼容）
│   ├── test.png
│   ├── test.jpg
│   ├── test.gif
│   └── test.svg
│
├── dynamic/          # 舊格式（向後兼容）
│   ├── demo.puml
│   ├── flow.mmd
│   └── error.puml
│
├── architecture/     # 新格式（自由路徑）
│   ├── system.d2
│   ├── database.erd
│   └── logo.png
│
├── diagrams/         # 新格式（測試各種圖表）
│   ├── flowchart.nomnoml
│   ├── network.nwdiag
│   ├── sequence.seqdiag
│   ├── waveform.wavedrom
│   ├── chart.vegalite
│   └── ascii.ditaa
│
└── process/
    ├── bpmn-flow.bpmn
    └── activity.actdiag
```

### 測試清單

**靜態圖片（向後兼容）：**
- [ ] PNG
- [ ] JPG
- [ ] GIF
- [ ] SVG

**原有動態圖表（向後兼容）：**
- [ ] PlantUML (.puml)
- [ ] Mermaid (.mmd)

**新增圖表類型：**
- [ ] D2 (.d2) - 現代架構圖
- [ ] ERD (.erd) - 資料庫 ER 圖
- [ ] Nomnoml (.nomnoml) - 簡單 UML
- [ ] Network Diagram (.nwdiag) - 網路拓樸
- [ ] Sequence Diagram (.seqdiag) - 序列圖
- [ ] WaveDrom (.wavedrom) - 時序波形圖
- [ ] Vega-Lite (.vegalite) - 數據視覺化
- [ ] Ditaa (.ditaa) - ASCII 藝術圖
- [ ] BPMN (.bpmn) - 業務流程
- [ ] Activity Diagram (.actdiag) - 活動圖

**錯誤處理：**
- [ ] 不支援的副檔名 → 錯誤圖片
- [ ] 語法錯誤 → 錯誤圖片
- [ ] 檔案不存在 → 錯誤圖片

---

## 📝 實作任務

### Phase 1: Router 重構
- [ ] 修改 `src/server/router.js` - 支援任意路徑
- [ ] 創建 `src/utils/extension-map.js` - 副檔名映射表
- [ ] 更新 `src/server/handlers/dynamic.js` - 接受 Kroki 類型參數

### Phase 2: 擴展圖表支援
- [ ] 更新 `src/utils/kroki.js` - 支援更多圖表類型
- [ ] 更新 `src/utils/mime-types.js` - 添加新副檔名

### Phase 3: 測試文件
- [ ] 創建各種圖表測試文件
- [ ] 更新 `demo/README.md` - 展示新功能

### Phase 4: 文檔更新
- [ ] 更新 `docs/ROADMAP.md`
- [ ] 更新 `src/README.md`
- [ ] 更新主 `README.md`

### Phase 5: 向後兼容測試
- [ ] 測試舊 URL 格式
- [ ] 測試新 URL 格式
- [ ] 測試混合使用

---

## ⚠️ 注意事項

1. **保持 livedoc/ 為固定根目錄** - 不變
2. **向後兼容** - 舊的 static/dynamic 路徑必須繼續可用
3. **錯誤處理一致** - 永遠返回 200 + image/png
4. **日誌格式** - 記錄完整路徑

---

## 📊 預期成果

**使用範例：**
```markdown
# 架構圖（自由路徑）
![系統架構](http://localhost:3000/myapp/livedoc/architecture/system.d2)
![資料庫設計](http://localhost:3000/myapp/livedoc/architecture/database.erd)

# 流程圖（自由路徑）
![業務流程](http://localhost:3000/myapp/livedoc/process/workflow.bpmn)
![活動圖](http://localhost:3000/myapp/livedoc/diagrams/activity.actdiag)

# 網路圖（自由路徑）
![網路拓樸](http://localhost:3000/myapp/livedoc/network/topology.nwdiag)

# 時序圖（自由路徑）
![波形圖](http://localhost:3000/myapp/livedoc/hardware/timing.wavedrom)

# 向後兼容（舊路徑）
![Logo](http://localhost:3000/myapp/livedoc/static/logo.png)
![PlantUML](http://localhost:3000/myapp/livedoc/dynamic/arch.puml)
```

---

**更新時間**: 2025-10-16
