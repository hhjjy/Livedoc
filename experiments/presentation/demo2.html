<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveDoc Demo 2 - å‹•æ…‹åºåˆ—åœ–åŸ·è¡Œè¦–è¦ºåŒ–</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js v7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <style>
        .sequence-line {
            stroke-dasharray: 5, 5;
        }
        
        .message-arrow {
            marker-end: url(#arrowhead);
        }
        
        .message-return {
            stroke-dasharray: 3, 3;
            marker-end: url(#arrowhead-open);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .executing {
            animation: pulse 1.5s infinite;
        }
        
        .error-glow {
            filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.8));
        }
        
        .disabled-actor {
            opacity: 0.3;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-800">
                ğŸ¬ LiveDoc Demo 2 - å‹•æ…‹åºåˆ—åœ–åŸ·è¡Œè¦–è¦ºåŒ–
            </h1>
            <p class="text-sm text-gray-600 mt-1">åŸºæ–¼å¯¦é©—å®¤è¦ç¯„çš„åºåˆ—åœ–ï¼Œå³æ™‚é¡¯ç¤ºåŸ·è¡Œç‹€æ…‹</p>
        </div>
    </header>

    <!-- Control Panel -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">ğŸ® åŸ·è¡Œæ§åˆ¶å°</h2>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="runScenario('success')" 
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                    âœ… å ´æ™¯1ï¼šå®Œæ•´æˆåŠŸåŸ·è¡Œ
                </button>
                <button onclick="runScenario('half-error')" 
                        class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                    âš ï¸ å ´æ™¯2ï¼šåŸ·è¡Œåˆ°ä¸€åŠéŒ¯èª¤
                </button>
                <button onclick="runScenario('late-error')" 
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition-all hover:shadow-lg">
                    âŒ å ´æ™¯3ï¼šåŸ·è¡Œåˆ°2/3éŒ¯èª¤
                </button>
            </div>
            <div class="mt-4 flex gap-4">
                <button onclick="resetDiagram()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-medium">
                    ğŸ”„ é‡ç½®
                </button>
                <button onclick="toggleSpeed()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium">
                    âš¡ é€Ÿåº¦: <span id="speed-label">æ­£å¸¸</span>
                </button>
            </div>
        </div>

        <!-- Main Diagram Area -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">ğŸ“Š ä½¿ç”¨è€…ç™»å…¥æµç¨‹æ¸¬è©¦ (Login Test)</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">ç‹€æ…‹:</span>
                    <span id="status-badge" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                        å¾…å‘½ä¸­
                    </span>
                </div>
            </div>
            
            <!-- SVG Container -->
            <div id="sequence-container" class="border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                <!-- D3.js will render here -->
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>åŸ·è¡Œé€²åº¦</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Execution Log -->
            <div class="mt-6 bg-gray-50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“ åŸ·è¡Œæ—¥èªŒ</h3>
                <div id="execution-log" class="space-y-1 text-xs font-mono max-h-40 overflow-y-auto">
                    <div class="text-gray-500">ç­‰å¾…åŸ·è¡Œ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let svg, g;
        let executionSpeed = 1000; // æ¯«ç§’
        let currentScenario = null;
        let isRunning = false;
        
        // å®šç¾©åƒèˆ‡è€…
        const actors = [
            { id: 'client', name: 'Test Client', x: 150, color: '#3B82F6' },
            { id: 'auth_vm', name: 'ValidationManager', x: 350, color: '#10B981' },
            { id: 'auth_em', name: 'EncryptionManager', x: 550, color: '#10B981' },
            { id: 'user_um', name: 'UserManager', x: 750, color: '#F59E0B' },
            { id: 'user_sm', name: 'SessionManager', x: 950, color: '#F59E0B' }
        ];
        
        // å®šç¾©åŸ·è¡Œæ­¥é©Ÿ
        const steps = [
            // Step 1: è¼¸å…¥é©—è­‰
            { id: '1.0', group: 'step1', from: 'client', to: 'auth_vm', action: '/validate_input', type: 'call', duration: 500 },
            { id: '1.1', group: 'step1', from: 'auth_vm', to: 'auth_vm', action: 'é©—è­‰æ ¼å¼', type: 'internal', duration: 300 },
            { id: '1.2', group: 'step1', from: 'auth_vm', to: 'client', action: 'é©—è­‰æˆåŠŸ', type: 'return', duration: 200 },
            
            // Step 2: å¯†ç¢¼è™•ç†
            { id: '2.0', group: 'step2', from: 'client', to: 'auth_em', action: '/encrypt_password', type: 'call', duration: 600 },
            { id: '2.1', group: 'step2', from: 'auth_em', to: 'auth_em', action: 'åŠ å¯†å¯†ç¢¼', type: 'internal', duration: 800 },
            { id: '2.2', group: 'step2', from: 'auth_em', to: 'client', action: 'å›å‚³åŠ å¯†çµæœ', type: 'return', duration: 200 },
            
            // Step 3: ä½¿ç”¨è€…é©—è­‰
            { id: '3.0', group: 'step3', from: 'client', to: 'user_um', action: '/find_user', type: 'call', duration: 700 },
            { id: '3.1', group: 'step3', from: 'user_um', to: 'user_um', action: 'æŸ¥è©¢ä½¿ç”¨è€…', type: 'internal', duration: 1000 },
            { id: '3.2', group: 'step3', from: 'user_um', to: 'client', action: 'å›å‚³ä½¿ç”¨è€…è³‡æ–™', type: 'return', duration: 300 },
            
            // Step 4: å»ºç«‹ Session
            { id: '4.0', group: 'step4', from: 'client', to: 'user_sm', action: '/create_session', type: 'call', duration: 500 },
            { id: '4.1', group: 'step4', from: 'user_sm', to: 'user_sm', action: 'å»ºç«‹ session', type: 'internal', duration: 600 },
            { id: '4.2', group: 'step4', from: 'user_sm', to: 'client', action: 'å›å‚³ token', type: 'return', duration: 200 }
        ];
        
        // åˆå§‹åŒ– SVG
        function initDiagram() {
            const container = d3.select('#sequence-container');
            container.selectAll('*').remove();
            
            const width = 1100;
            const height = 850;  // å¢åŠ é«˜åº¦ä»¥å®¹ç´æ‰€æœ‰æ­¥é©Ÿ
            
            svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // å®šç¾©ç®­é ­æ¨™è¨˜
            const defs = svg.append('defs');
            
            // å¯¦å¿ƒç®­é ­
            defs.append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', '#333');
            
            // ç©ºå¿ƒç®­é ­ï¼ˆç”¨æ–¼è¿”å›ï¼‰
            defs.append('marker')
                .attr('id', 'arrowhead-open')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', 'none')
                .attr('stroke', '#333')
                .attr('stroke-width', 1.5);
            
            g = svg.append('g');
            
            // ç¹ªè£½æ¨™é¡Œ
            g.append('text')
                .attr('x', width / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('font-size', '18px')
                .attr('font-weight', 'bold')
                .attr('fill', '#1F2937')
                .text('ä½¿ç”¨è€…ç™»å…¥æµç¨‹æ¸¬è©¦');
            
            // ç¹ªè£½æ¨¡çµ„èƒŒæ™¯
            // Authentication Module
            g.append('rect')
                .attr('x', 280)
                .attr('y', 60)
                .attr('width', 340)
                .attr('height', height - 100)  // èª¿æ•´åº•éƒ¨é‚Šè·
                .attr('fill', '#D1FAE5')
                .attr('stroke', '#10B981')
                .attr('stroke-width', 1)
                .attr('rx', 5)
                .attr('opacity', 0.3);
            
            g.append('text')
                .attr('x', 450)
                .attr('y', 80)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('fill', '#059669')
                .text('Authentication Module');
            
            // User Module
            g.append('rect')
                .attr('x', 680)
                .attr('y', 60)
                .attr('width', 340)
                .attr('height', height - 100)  // èª¿æ•´åº•éƒ¨é‚Šè·
                .attr('fill', '#FED7AA')
                .attr('stroke', '#F59E0B')
                .attr('stroke-width', 1)
                .attr('rx', 5)
                .attr('opacity', 0.3);
            
            g.append('text')
                .attr('x', 850)
                .attr('y', 80)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('fill', '#D97706')
                .text('User Module');
            
            // ç¹ªè£½ Actor å’Œç”Ÿå‘½ç·š
            actors.forEach(actor => {
                // Actor åœ–ç¤º
                const actorG = g.append('g')
                    .attr('class', `actor-${actor.id}`)
                    .attr('transform', `translate(${actor.x}, 100)`);
                
                // Actor æ–¹æ¡†
                actorG.append('rect')
                    .attr('x', -60)
                    .attr('y', -20)
                    .attr('width', 120)
                    .attr('height', 40)
                    .attr('fill', 'white')
                    .attr('stroke', actor.color)
                    .attr('stroke-width', 2)
                    .attr('rx', 5);
                
                // Actor åç¨±
                actorG.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('y', 5)
                    .attr('font-size', '12px')
                    .attr('font-weight', 'bold')
                    .attr('fill', '#1F2937')
                    .text(actor.name);
                
                // ç”Ÿå‘½ç·š
                g.append('line')
                    .attr('class', `lifeline-${actor.id}`)
                    .attr('x1', actor.x)
                    .attr('y1', 120)
                    .attr('x2', actor.x)
                    .attr('y2', height - 50)  // èª¿æ•´ç”Ÿå‘½ç·šåº•éƒ¨ä½ç½®
                    .attr('stroke', '#9CA3AF')
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '5,5');
            });
        }
        
        // åŸ·è¡Œå–®å€‹æ­¥é©Ÿ
        async function executeStep(step, shouldFail = false) {
            const fromActor = actors.find(a => a.id === step.from);
            const toActor = actors.find(a => a.id === step.to);
            const y = 150 + (steps.indexOf(step) * 45);  // å¢åŠ é–“è·åˆ° 45
            
            // æ›´æ–°æ—¥èªŒ
            const log = document.getElementById('execution-log');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            
            if (shouldFail) {
                // éŒ¯èª¤ç‹€æ…‹
                log.innerHTML += `<div class="text-red-600">[${timestamp}] âŒ ${step.id}: ${step.action} - åŸ·è¡Œå¤±æ•—!</div>`;
                
                // ç¹ªè£½éŒ¯èª¤è¨Šæ¯
                const messageG = g.append('g')
                    .attr('class', 'message error-glow')
                    .attr('opacity', 0);
                
                if (step.type === 'internal') {
                    // è‡ªæˆ‘å‘¼å«
                    messageG.append('rect')
                        .attr('x', fromActor.x + 10)
                        .attr('y', y - 10)
                        .attr('width', 80)
                        .attr('height', 20)
                        .attr('fill', 'none')
                        .attr('stroke', '#EF4444')
                        .attr('stroke-width', 2);
                    
                    messageG.append('text')
                        .attr('x', fromActor.x + 50)
                        .attr('y', y + 3)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '11px')
                        .attr('fill', '#EF4444')
                        .attr('font-weight', 'bold')
                        .text('ERROR!');
                } else {
                    // è·¨ Actor å‘¼å«
                    messageG.append('line')
                        .attr('x1', fromActor.x)
                        .attr('y1', y)
                        .attr('x2', toActor.x)
                        .attr('y2', y)
                        .attr('stroke', '#EF4444')
                        .attr('stroke-width', 2)
                        .attr('marker-end', step.type === 'return' ? 'url(#arrowhead-open)' : 'url(#arrowhead)');
                    
                    messageG.append('text')
                        .attr('x', (fromActor.x + toActor.x) / 2)
                        .attr('y', y - 5)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '11px')
                        .attr('fill', '#EF4444')
                        .attr('font-weight', 'bold')
                        .text('âŒ éŒ¯èª¤');
                }
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                messageG.transition()
                    .duration(300)
                    .attr('opacity', 1);
                
                // æ›´æ–°ç‹€æ…‹
                updateStatus('error', `éŒ¯èª¤æ–¼æ­¥é©Ÿ ${step.id}`);
                
                throw new Error(`Step ${step.id} failed`);
            }
            
            // æ­£å¸¸åŸ·è¡Œ
            log.innerHTML += `<div class="text-green-600">[${timestamp}] âœ… ${step.id}: ${step.action}</div>`;
            
            // ç¹ªè£½è¨Šæ¯
            const messageG = g.append('g')
                .attr('class', 'message executing')
                .attr('opacity', 0);
            
            if (step.type === 'internal') {
                // è‡ªæˆ‘å‘¼å«çš„çŸ©å½¢
                const rect = messageG.append('rect')
                    .attr('x', fromActor.x + 10)
                    .attr('y', y - 10)
                    .attr('width', 80)
                    .attr('height', 20)
                    .attr('fill', 'none')
                    .attr('stroke', '#333')
                    .attr('stroke-width', 1.5);
                
                messageG.append('text')
                    .attr('x', fromActor.x + 50)
                    .attr('y', y + 3)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '11px')
                    .attr('fill', '#333')
                    .text(step.action);
            } else {
                // è·¨ Actor çš„ç®­é ­
                const line = messageG.append('line')
                    .attr('x1', fromActor.x)
                    .attr('y1', y)
                    .attr('x2', toActor.x)
                    .attr('y2', y)
                    .attr('stroke', '#333')
                    .attr('stroke-width', 1.5);
                
                if (step.type === 'return') {
                    line.attr('stroke-dasharray', '3,3')
                        .attr('marker-end', 'url(#arrowhead-open)');
                } else {
                    line.attr('marker-end', 'url(#arrowhead)');
                }
                
                // è¨Šæ¯æ¨™ç±¤
                messageG.append('text')
                    .attr('x', (fromActor.x + toActor.x) / 2)
                    .attr('y', y - 5)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '11px')
                    .attr('fill', '#333')
                    .text(step.action);
                
                // åŸ·è¡Œæ™‚é–“æ¨™ç±¤
                const timeLabel = messageG.append('text')
                    .attr('x', (fromActor.x + toActor.x) / 2)
                    .attr('y', y + 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', '#10B981')
                    .attr('font-weight', 'bold')
                    .attr('opacity', 0);
            }
            
            // é¡¯ç¤ºè¨Šæ¯å‹•ç•«
            await messageG.transition()
                .duration(300)
                .attr('opacity', 1)
                .end();
            
            // æ¨¡æ“¬åŸ·è¡Œæ™‚é–“
            await new Promise(resolve => setTimeout(resolve, step.duration / (executionSpeed === 500 ? 2 : 1)));
            
            // å®Œæˆå¾Œç§»é™¤åŸ·è¡Œä¸­çš„å‹•ç•«
            messageG.classed('executing', false);
            
            // é¡¯ç¤ºåŸ·è¡Œæ™‚é–“
            if (step.type !== 'internal') {
                messageG.select('text:last-child')
                    .text(`${step.duration}ms`)
                    .transition()
                    .duration(200)
                    .attr('opacity', 1);
            }
            
            log.scrollTop = log.scrollHeight;
        }
        
        // åŸ·è¡Œå ´æ™¯
        async function runScenario(scenario) {
            if (isRunning) return;
            isRunning = true;
            currentScenario = scenario;
            
            // é‡ç½®
            resetDiagram();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // æ›´æ–°ç‹€æ…‹
            updateStatus('running', 'åŸ·è¡Œä¸­...');
            
            const log = document.getElementById('execution-log');
            log.innerHTML = `<div class="text-blue-600 font-bold">é–‹å§‹åŸ·è¡Œå ´æ™¯: ${getScenarioName(scenario)}</div>`;
            
            let failAtStep = -1;
            if (scenario === 'half-error') {
                failAtStep = 5; // Step 2.2 æ™‚å¤±æ•—
            } else if (scenario === 'late-error') {
                failAtStep = 8; // Step 3.2 æ™‚å¤±æ•—
            }
            
            try {
                for (let i = 0; i < steps.length; i++) {
                    const shouldFail = (i === failAtStep);
                    
                    // æ›´æ–°é€²åº¦
                    const progress = Math.round(((i + 1) / steps.length) * 100);
                    updateProgress(shouldFail ? progress : Math.min(progress, 100));
                    
                    await executeStep(steps[i], shouldFail);
                    
                    if (i === failAtStep) {
                        // è™›åŒ–å¾ŒçºŒæ­¥é©Ÿ
                        disableRemainingSteps(i);
                        break;
                    }
                }
                
                if (scenario === 'success') {
                    updateStatus('success', 'åŸ·è¡Œå®Œæˆ');
                    log.innerHTML += `<div class="text-green-600 font-bold mt-2">âœ… æ‰€æœ‰æ­¥é©ŸåŸ·è¡ŒæˆåŠŸï¼</div>`;
                }
            } catch (error) {
                log.innerHTML += `<div class="text-red-600 font-bold mt-2">âŒ åŸ·è¡Œä¸­æ–·: ${error.message}</div>`;
                
                // é¡¯ç¤ºé‡è©¦æç¤º
                setTimeout(() => {
                    log.innerHTML += `<div class="text-orange-600">ğŸ’¡ æç¤º: é»æ“Šé‡ç½®æŒ‰éˆ•å¾Œå¯é‡æ–°åŸ·è¡Œ</div>`;
                }, 1000);
            }
            
            isRunning = false;
        }
        
        // è™›åŒ–å‰©é¤˜æ­¥é©Ÿ
        function disableRemainingSteps(fromIndex) {
            const remainingSteps = steps.slice(fromIndex + 1);
            const affectedActors = new Set();
            
            remainingSteps.forEach(step => {
                affectedActors.add(step.from);
                affectedActors.add(step.to);
                
                const fromActor = actors.find(a => a.id === step.from);
                const toActor = actors.find(a => a.id === step.to);
                const y = 150 + (steps.indexOf(step) * 45);  // ä¿æŒä¸€è‡´çš„é–“è·
                
                // ç¹ªè£½è™›åŒ–çš„è¨Šæ¯
                const messageG = g.append('g')
                    .attr('class', 'message disabled')
                    .attr('opacity', 0.2);
                
                if (step.type === 'internal') {
                    messageG.append('rect')
                        .attr('x', fromActor.x + 10)
                        .attr('y', y - 10)
                        .attr('width', 80)
                        .attr('height', 20)
                        .attr('fill', 'none')
                        .attr('stroke', '#9CA3AF')
                        .attr('stroke-width', 1)
                        .attr('stroke-dasharray', '2,2');
                    
                    messageG.append('text')
                        .attr('x', fromActor.x + 50)
                        .attr('y', y + 3)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '10px')
                        .attr('fill', '#9CA3AF')
                        .text(step.action);
                } else {
                    const line = messageG.append('line')
                        .attr('x1', fromActor.x)
                        .attr('y1', y)
                        .attr('x2', toActor.x)
                        .attr('y2', y)
                        .attr('stroke', '#9CA3AF')
                        .attr('stroke-width', 1)
                        .attr('stroke-dasharray', '2,2');
                    
                    messageG.append('text')
                        .attr('x', (fromActor.x + toActor.x) / 2)
                        .attr('y', y - 5)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '10px')
                        .attr('fill', '#9CA3AF')
                        .text(step.action);
                }
            });
            
            // è™›åŒ–å—å½±éŸ¿çš„ Actors
            affectedActors.forEach(actorId => {
                if (actorId !== 'client') { // Client é€šå¸¸ä¸è™›åŒ–
                    g.select(`.actor-${actorId}`)
                        .transition()
                        .duration(500)
                        .attr('opacity', 0.3);
                }
            });
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(type, text) {
            const badge = document.getElementById('status-badge');
            
            switch(type) {
                case 'running':
                    badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700';
                    break;
                case 'success':
                    badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                    break;
                case 'error':
                    badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
                    break;
                default:
                    badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
            }
            
            badge.textContent = text;
        }
        
        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent}%`;
        }
        
        // é‡ç½®åœ–è¡¨
        function resetDiagram() {
            initDiagram();
            updateStatus('idle', 'å¾…å‘½ä¸­');
            updateProgress(0);
            document.getElementById('execution-log').innerHTML = '<div class="text-gray-500">ç­‰å¾…åŸ·è¡Œ...</div>';
        }
        
        // åˆ‡æ›é€Ÿåº¦
        function toggleSpeed() {
            const speedLabel = document.getElementById('speed-label');
            if (executionSpeed === 1000) {
                executionSpeed = 500;
                speedLabel.textContent = 'å¿«é€Ÿ';
            } else {
                executionSpeed = 1000;
                speedLabel.textContent = 'æ­£å¸¸';
            }
        }
        
        // ç²å–å ´æ™¯åç¨±
        function getScenarioName(scenario) {
            switch(scenario) {
                case 'success': return 'å®Œæ•´æˆåŠŸåŸ·è¡Œ';
                case 'half-error': return 'åŸ·è¡Œåˆ°ä¸€åŠéŒ¯èª¤';
                case 'late-error': return 'åŸ·è¡Œåˆ°2/3éŒ¯èª¤';
                default: return 'æœªçŸ¥å ´æ™¯';
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initDiagram();
        });
    </script>
</body>
</html>
