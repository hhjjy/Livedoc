<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveDoc - PlantUML Log Player</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js v7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .executing {
            animation: pulse 1.5s infinite;
        }
        
        .log-line {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .log-highlight {
            background-color: #fef3c7;
            border-left: 3px solid #f59e0b;
        }
        
        .timeline-bar {
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--progress), #e5e7eb var(--progress));
        }
        
        .actor-box {
            transition: all 0.3s ease;
        }
        
        .actor-active {
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-gray-800">
                        ğŸ¬ LiveDoc - PlantUML Log Player
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">å°‡ Log æª”æ¡ˆè½‰æ›æˆå‹•æ…‹åºåˆ—åœ–æ’­æ”¾</p>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-medium">
                        æ¦‚å¿µå±•ç¤º
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Input Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">ğŸ“ Log è¼¸å…¥</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button onclick="loadExample('success')" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                    ğŸ“Š ç¯„ä¾‹ 1ï¼šæ­£å¸¸åŸ·è¡Œ
                </button>
                <button onclick="loadExample('error')" 
                        class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition">
                    âš ï¸ ç¯„ä¾‹ 2ï¼šåŸ·è¡ŒéŒ¯èª¤
                </button>
                <button onclick="loadExample('slow')" 
                        class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">
                    ğŸŒ ç¯„ä¾‹ 3ï¼šæ•ˆèƒ½å•é¡Œ
                </button>
            </div>
            
            <div class="border border-gray-200 rounded-lg">
                <textarea id="log-input" 
                          class="w-full p-4 font-mono text-xs text-gray-700 bg-gray-50 rounded-lg"
                          rows="8"
                          placeholder="è²¼ä¸Šä½ çš„ Log æˆ–é¸æ“‡ç¯„ä¾‹...">
                </textarea>
            </div>
            
            <div class="mt-4 flex gap-4">
                <button onclick="parseAndPlay()" 
                        class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium">
                    ğŸš€ è§£æä¸¦æ’­æ”¾
                </button>
                <button onclick="clearAll()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                    ğŸ”„ æ¸…é™¤
                </button>
            </div>
        </div>

        <!-- Player Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">â–¶ï¸ æ’­æ”¾å™¨</h2>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-600">ç‹€æ…‹:</span>
                    <span id="player-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                        å¾…æ©Ÿä¸­
                    </span>
                </div>
            </div>
            
            <!-- Control Bar -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-4">
                    <button onclick="playPause()" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                        <span id="play-btn-text">â–¶ï¸ æ’­æ”¾</span>
                    </button>
                    <button onclick="reset()" 
                            class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                        â¹ï¸ åœæ­¢
                    </button>
                    
                    <div class="flex items-center gap-2 ml-4">
                        <label class="text-sm text-gray-600">é€Ÿåº¦:</label>
                        <select id="speed-select" onchange="changeSpeed()" 
                                class="px-2 py-1 border border-gray-300 rounded text-sm">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                        </select>
                    </div>
                    
                    <div class="flex-1 ml-4">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600" id="current-time">00:00</span>
                            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div id="progress-bar" 
                                     class="h-full bg-blue-500 transition-all duration-300"
                                     style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600" id="total-time">00:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sequence Diagram -->
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                <div id="sequence-container" style="min-height: 500px;">
                    <!-- D3.js æœƒåœ¨é€™è£¡ç¹ªè£½åºåˆ—åœ– -->
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="mt-4 grid grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="stat-total">0</div>
                    <div class="text-xs text-gray-600">ç¸½äº‹ä»¶æ•¸</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-600" id="stat-success">0</div>
                    <div class="text-xs text-gray-600">æˆåŠŸ</div>
                </div>
                <div class="bg-red-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-red-600" id="stat-error">0</div>
                    <div class="text-xs text-gray-600">éŒ¯èª¤</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="stat-duration">0ms</div>
                    <div class="text-xs text-gray-600">ç¸½è€—æ™‚</div>
                </div>
            </div>
        </div>

        <!-- Current Log Display -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">ğŸ“‹ ç•¶å‰ Log</h2>
            <div class="bg-gray-900 text-green-400 rounded-lg p-4 max-h-48 overflow-y-auto">
                <div id="current-log-display" class="font-mono text-xs">
                    <div class="text-gray-500">ç­‰å¾… Log è¼¸å…¥...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let svg, g;
        let timeline = [];
        let currentIndex = 0;
        let isPlaying = false;
        let playbackSpeed = 1;
        let playInterval = null;
        let actors = new Map();
        let startTime, endTime;
        
        // ç¯„ä¾‹ Log
        const examples = {
            success: `2024-01-01 10:00:00.000 [INFO] transaction=tx001 from=FE to=Conv_CM action=call api=/delete_conversation
2024-01-01 10:00:00.150 [INFO] transaction=tx001 from=Conv_CM to=Meta_CM action=call api=/get_conversation_metadata
2024-01-01 10:00:00.280 [INFO] transaction=tx001 from=Meta_CM to=Conv_CM action=return status=200 message=metadata_found
2024-01-01 10:00:00.350 [INFO] transaction=tx001 from=Conv_CM to=Conv_TM action=call api=/delete_text
2024-01-01 10:00:00.500 [INFO] transaction=tx001 from=Conv_TM to=Meta_TM action=call api=/get_text_metadata
2024-01-01 10:00:00.650 [INFO] transaction=tx001 from=Meta_TM to=Conv_TM action=return status=200 message=text_metadata_found
2024-01-01 10:00:00.750 [INFO] transaction=tx001 from=Conv_TM to=Conv_TM action=internal message=deleting_text_files
2024-01-01 10:00:00.950 [INFO] transaction=tx001 from=Conv_TM to=Meta_TM action=call api=/delete_text_metadata
2024-01-01 10:00:01.100 [INFO] transaction=tx001 from=Meta_TM to=Conv_TM action=return status=200 message=deleted
2024-01-01 10:00:01.200 [INFO] transaction=tx001 from=Conv_TM to=Conv_CM action=return status=200 message=text_deleted
2024-01-01 10:00:01.300 [INFO] transaction=tx001 from=Conv_CM to=Topic_TM action=call api=/delete_topic
2024-01-01 10:00:01.500 [INFO] transaction=tx001 from=Topic_TM to=Topic_B action=call api=/broker/delete_topic
2024-01-01 10:00:01.800 [INFO] transaction=tx001 from=Topic_B to=Topic_TM action=return status=200 message=topic_deleted
2024-01-01 10:00:01.900 [INFO] transaction=tx001 from=Topic_TM to=Conv_CM action=return status=200 message=success
2024-01-01 10:00:02.000 [INFO] transaction=tx001 from=Conv_CM to=Meta_CM action=call api=/delete_conversation_metadata
2024-01-01 10:00:02.150 [INFO] transaction=tx001 from=Meta_CM to=Conv_CM action=return status=200 message=metadata_deleted
2024-01-01 10:00:02.200 [INFO] transaction=tx001 from=Conv_CM to=FE action=return status=200 message=conversation_deleted`,

            error: `2024-01-01 10:00:00.000 [INFO] transaction=tx002 from=FE to=Conv_CM action=call api=/delete_conversation
2024-01-01 10:00:00.150 [INFO] transaction=tx002 from=Conv_CM to=Meta_CM action=call api=/get_conversation_metadata
2024-01-01 10:00:00.280 [INFO] transaction=tx002 from=Meta_CM to=Conv_CM action=return status=200 message=metadata_found
2024-01-01 10:00:00.350 [INFO] transaction=tx002 from=Conv_CM to=Conv_TM action=call api=/delete_text
2024-01-01 10:00:00.500 [INFO] transaction=tx002 from=Conv_TM to=Meta_TM action=call api=/get_text_metadata
2024-01-01 10:00:00.650 [ERROR] transaction=tx002 from=Meta_TM to=Conv_TM action=return status=404 error=text_metadata_not_found
2024-01-01 10:00:00.700 [ERROR] transaction=tx002 from=Conv_TM to=Conv_CM action=return status=500 error=failed_to_delete_text
2024-01-01 10:00:00.750 [ERROR] transaction=tx002 from=Conv_CM to=FE action=return status=500 error=deletion_failed`,

            slow: `2024-01-01 10:00:00.000 [INFO] transaction=tx003 from=FE to=Conv_CM action=call api=/delete_conversation
2024-01-01 10:00:00.150 [INFO] transaction=tx003 from=Conv_CM to=Meta_CM action=call api=/get_conversation_metadata
2024-01-01 10:00:00.280 [INFO] transaction=tx003 from=Meta_CM to=Conv_CM action=return status=200 message=metadata_found
2024-01-01 10:00:00.350 [INFO] transaction=tx003 from=Conv_CM to=Conv_TM action=call api=/delete_text
2024-01-01 10:00:00.500 [INFO] transaction=tx003 from=Conv_TM to=Meta_TM action=call api=/get_text_metadata
2024-01-01 10:00:03.650 [WARN] transaction=tx003 from=Meta_TM to=Conv_TM action=return status=200 message=slow_response time=3150ms
2024-01-01 10:00:03.750 [INFO] transaction=tx003 from=Conv_TM to=Conv_TM action=internal message=deleting_text_files
2024-01-01 10:00:03.950 [INFO] transaction=tx003 from=Conv_TM to=Meta_TM action=call api=/delete_text_metadata
2024-01-01 10:00:07.100 [WARN] transaction=tx003 from=Meta_TM to=Conv_TM action=return status=200 message=slow_deletion time=3150ms
2024-01-01 10:00:07.200 [INFO] transaction=tx003 from=Conv_TM to=Conv_CM action=return status=200 message=text_deleted
2024-01-01 10:00:07.300 [INFO] transaction=tx003 from=Conv_CM to=FE action=return status=200 message=conversation_deleted_slowly total_time=7300ms`
        };
        
        // è¼‰å…¥ç¯„ä¾‹
        function loadExample(type) {
            document.getElementById('log-input').value = examples[type];
            updateStatus('ready', 'ç¯„ä¾‹å·²è¼‰å…¥');
        }
        
        // è§£æ Log
        function parseLog(logText) {
            const lines = logText.trim().split('\n');
            const events = [];
            actors.clear();
            
            lines.forEach((line, index) => {
                // è§£æ Log æ ¼å¼
                const timeMatch = line.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})/);
                const levelMatch = line.match(/\[(INFO|WARN|ERROR)\]/);
                const fromMatch = line.match(/from=(\w+)/);
                const toMatch = line.match(/to=(\w+)/);
                const actionMatch = line.match(/action=(\w+)/);
                const apiMatch = line.match(/api=([\w\/]+)/);
                const statusMatch = line.match(/status=(\d+)/);
                const messageMatch = line.match(/message=(\w+)/);
                const errorMatch = line.match(/error=([\w_]+)/);
                
                if (timeMatch && fromMatch && toMatch) {
                    const event = {
                        timestamp: new Date(timeMatch[1]),
                        level: levelMatch ? levelMatch[1] : 'INFO',
                        from: fromMatch[1],
                        to: toMatch[1],
                        action: actionMatch ? actionMatch[1] : 'unknown',
                        api: apiMatch ? apiMatch[1] : null,
                        status: statusMatch ? parseInt(statusMatch[1]) : null,
                        message: messageMatch ? messageMatch[1] : null,
                        error: errorMatch ? errorMatch[1] : null,
                        rawLine: line,
                        index: index
                    };
                    
                    events.push(event);
                    
                    // æ”¶é›† actors
                    if (!actors.has(event.from)) {
                        actors.set(event.from, { name: event.from, count: 0 });
                    }
                    if (!actors.has(event.to)) {
                        actors.set(event.to, { name: event.to, count: 0 });
                    }
                    actors.get(event.from).count++;
                    actors.get(event.to).count++;
                }
            });
            
            // è¨ˆç®—æ™‚é–“å·®
            if (events.length > 0) {
                startTime = events[0].timestamp;
                endTime = events[events.length - 1].timestamp;
                
                events.forEach(event => {
                    event.relativeTime = event.timestamp - startTime;
                });
            }
            
            return events;
        }
        
        // åˆå§‹åŒ–åºåˆ—åœ–
        function initDiagram() {
            const container = d3.select('#sequence-container');
            container.selectAll('*').remove();
            
            const actorList = Array.from(actors.keys());
            const width = Math.max(900, actorList.length * 150);
            const height = 500;
            
            svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // å®šç¾©ç®­é ­
            const defs = svg.append('defs');
            
            defs.append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', '#333');
            
            defs.append('marker')
                .attr('id', 'arrowhead-error')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', '#ef4444');
            
            g = svg.append('g');
            
            // æ¨™é¡Œ
            g.append('text')
                .attr('x', width / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('font-size', '18px')
                .attr('font-weight', 'bold')
                .text('Log Replay Sequence Diagram');
            
            // ç¹ªè£½ Actors
            const spacing = width / (actorList.length + 1);
            
            actorList.forEach((actorName, i) => {
                const x = spacing * (i + 1);
                const actor = actors.get(actorName);
                actor.x = x;
                
                const actorG = g.append('g')
                    .attr('class', `actor actor-${actorName}`)
                    .attr('transform', `translate(${x}, 70)`);
                
                actorG.append('rect')
                    .attr('class', 'actor-box')
                    .attr('x', -40)
                    .attr('y', -20)
                    .attr('width', 80)
                    .attr('height', 40)
                    .attr('fill', 'white')
                    .attr('stroke', getActorColor(actorName))
                    .attr('stroke-width', 2)
                    .attr('rx', 5);
                
                actorG.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('y', 5)
                    .attr('font-size', '12px')
                    .attr('font-weight', 'bold')
                    .text(actorName);
                
                // ç”Ÿå‘½ç·š
                g.append('line')
                    .attr('class', `lifeline lifeline-${actorName}`)
                    .attr('x1', x)
                    .attr('y1', 90)
                    .attr('x2', x)
                    .attr('y2', height - 30)
                    .attr('stroke', '#9CA3AF')
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '5,5');
            });
        }
        
        // å–å¾— Actor é¡è‰²
        function getActorColor(name) {
            if (name === 'FE') return '#3B82F6';
            if (name.includes('Conv')) return '#10B981';
            if (name.includes('Meta')) return '#F59E0B';
            if (name.includes('Topic')) return '#8B5CF6';
            return '#6B7280';
        }
        
        // ç¹ªè£½å–®å€‹äº‹ä»¶
        function drawEvent(event, index) {
            const fromActor = actors.get(event.from);
            const toActor = actors.get(event.to);
            const y = 120 + (index * 25);
            
            // é«˜äº® actors
            g.selectAll('.actor-box').classed('actor-active', false);
            g.select(`.actor-${event.from} .actor-box`).classed('actor-active', true);
            g.select(`.actor-${event.to} .actor-box`).classed('actor-active', true);
            
            // ç¹ªè£½è¨Šæ¯
            const messageG = g.append('g')
                .attr('class', `message message-${index}`)
                .attr('opacity', 0);
            
            const isError = event.level === 'ERROR';
            const isWarn = event.level === 'WARN';
            const color = isError ? '#ef4444' : isWarn ? '#f59e0b' : '#333';
            
            if (event.from === event.to) {
                // è‡ªæˆ‘å‘¼å«
                messageG.append('rect')
                    .attr('x', fromActor.x + 10)
                    .attr('y', y - 10)
                    .attr('width', 70)
                    .attr('height', 20)
                    .attr('fill', 'none')
                    .attr('stroke', color)
                    .attr('stroke-width', 1.5);
                
                messageG.append('text')
                    .attr('x', fromActor.x + 45)
                    .attr('y', y + 3)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', color)
                    .text(event.action);
            } else {
                // è·¨ Actor å‘¼å«
                const line = messageG.append('line')
                    .attr('x1', fromActor.x)
                    .attr('y1', y)
                    .attr('x2', toActor.x)
                    .attr('y2', y)
                    .attr('stroke', color)
                    .attr('stroke-width', isError ? 2 : 1.5)
                    .attr('marker-end', isError ? 'url(#arrowhead-error)' : 'url(#arrowhead)');
                
                if (event.action === 'return') {
                    line.attr('stroke-dasharray', '3,3');
                }
                
                // è¨Šæ¯æ–‡å­—
                let label = event.api || event.action;
                if (event.status) label += ` (${event.status})`;
                if (event.error) label = `âŒ ${event.error}`;
                
                messageG.append('text')
                    .attr('x', (fromActor.x + toActor.x) / 2)
                    .attr('y', y - 5)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', color)
                    .attr('font-weight', isError ? 'bold' : 'normal')
                    .text(label);
                
                // æ™‚é–“æ¨™ç±¤
                if (event.relativeTime > 0) {
                    messageG.append('text')
                        .attr('x', (fromActor.x + toActor.x) / 2)
                        .attr('y', y + 12)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '9px')
                        .attr('fill', '#10B981')
                        .text(`+${event.relativeTime}ms`);
                }
            }
            
            // æ·¡å…¥å‹•ç•«
            messageG.transition()
                .duration(200)
                .attr('opacity', 1);
            
            // æ›´æ–°ç•¶å‰ log é¡¯ç¤º
            const logDisplay = document.getElementById('current-log-display');
            const existingLogs = logDisplay.querySelectorAll('.log-line');
            existingLogs.forEach(log => log.classList.remove('log-highlight'));
            
            const logLine = document.createElement('div');
            logLine.className = 'log-line log-highlight';
            logLine.textContent = event.rawLine;
            logDisplay.appendChild(logLine);
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }
        
        // è§£æä¸¦æ’­æ”¾
        function parseAndPlay() {
            const logText = document.getElementById('log-input').value;
            if (!logText.trim()) {
                alert('è«‹è¼¸å…¥ Log æˆ–é¸æ“‡ç¯„ä¾‹');
                return;
            }
            
            timeline = parseLog(logText);
            if (timeline.length === 0) {
                alert('ç„¡æ³•è§£æ Logï¼Œè«‹æª¢æŸ¥æ ¼å¼');
                return;
            }
            
            // åˆå§‹åŒ–åœ–è¡¨
            initDiagram();
            currentIndex = 0;
            
            // æ›´æ–°çµ±è¨ˆ
            updateStatistics();
            
            // æ›´æ–°æ™‚é–“é¡¯ç¤º
            const duration = endTime - startTime;
            document.getElementById('total-time').textContent = formatTime(duration);
            
            updateStatus('ready', 'æº–å‚™æ’­æ”¾');
        }
        
        // æ’­æ”¾/æš«åœ
        function playPause() {
            if (timeline.length === 0) {
                alert('è«‹å…ˆè§£æ Log');
                return;
            }
            
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }
        
        // æ’­æ”¾
        function play() {
            if (currentIndex >= timeline.length) {
                currentIndex = 0;
                g.selectAll('.message').remove();
            }
            
            isPlaying = true;
            document.getElementById('play-btn-text').textContent = 'â¸ï¸ æš«åœ';
            updateStatus('playing', 'æ’­æ”¾ä¸­');
            
            playNext();
        }
        
        // æš«åœ
        function pause() {
            isPlaying = false;
            document.getElementById('play-btn-text').textContent = 'â–¶ï¸ æ’­æ”¾';
            updateStatus('paused', 'å·²æš«åœ');
            
            if (playInterval) {
                clearTimeout(playInterval);
            }
        }
        
        // æ’­æ”¾ä¸‹ä¸€å€‹äº‹ä»¶
        function playNext() {
            if (!isPlaying || currentIndex >= timeline.length) {
                if (currentIndex >= timeline.length) {
                    // æ’­æ”¾çµæŸ
                    isPlaying = false;
                    document.getElementById('play-btn-text').textContent = 'â–¶ï¸ æ’­æ”¾';
                    updateStatus('finished', 'æ’­æ”¾å®Œæˆ');
                }
                return;
            }
            
            const event = timeline[currentIndex];
            drawEvent(event, currentIndex);
            
            // æ›´æ–°é€²åº¦
            const progress = ((currentIndex + 1) / timeline.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('current-time').textContent = formatTime(event.relativeTime);
            
            currentIndex++;
            
            // è¨ˆç®—ä¸‹ä¸€å€‹äº‹ä»¶çš„å»¶é²
            let delay = 500 / playbackSpeed; // é è¨­å»¶é²
            if (currentIndex < timeline.length) {
                const nextEvent = timeline[currentIndex];
                const timeDiff = nextEvent.relativeTime - event.relativeTime;
                if (timeDiff > 0) {
                    delay = Math.min(timeDiff / playbackSpeed, 2000 / playbackSpeed);
                }
            }
            
            playInterval = setTimeout(() => playNext(), delay);
        }
        
        // é‡ç½®
        function reset() {
            pause();
            currentIndex = 0;
            if (g) {
                g.selectAll('.message').remove();
                g.selectAll('.actor-box').classed('actor-active', false);
            }
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('current-time').textContent = '00:00';
            updateStatus('ready', 'å·²é‡ç½®');
        }
        
        // æ¸…é™¤å…¨éƒ¨
        function clearAll() {
            reset();
            document.getElementById('log-input').value = '';
            document.getElementById('current-log-display').innerHTML = '<div class="text-gray-500">ç­‰å¾… Log è¼¸å…¥...</div>';
            timeline = [];
            actors.clear();
            if (svg) {
                d3.select('#sequence-container').selectAll('*').remove();
            }
            updateStatus('idle', 'å¾…æ©Ÿä¸­');
        }
        
        // æ”¹è®Šé€Ÿåº¦
        function changeSpeed() {
            const select = document.getElementById('speed-select');
            playbackSpeed = parseFloat(select.value);
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(type, text) {
            const status = document.getElementById('player-status');
            status.textContent = text;
            
            status.className = 'px-3 py-1 rounded-full text-sm font-medium ';
            switch(type) {
                case 'playing':
                    status.className += 'bg-green-100 text-green-700';
                    break;
                case 'paused':
                    status.className += 'bg-yellow-100 text-yellow-700';
                    break;
                case 'error':
                    status.className += 'bg-red-100 text-red-700';
                    break;
                case 'finished':
                    status.className += 'bg-blue-100 text-blue-700';
                    break;
                default:
                    status.className += 'bg-gray-100 text-gray-700';
            }
        }
        
        // æ›´æ–°çµ±è¨ˆ
        function updateStatistics() {
            const total = timeline.length;
            const errors = timeline.filter(e => e.level === 'ERROR').length;
            const success = total - errors;
            const duration = endTime - startTime;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-success').textContent = success;
            document.getElementById('stat-error').textContent = errors;
            document.getElementById('stat-duration').textContent = `${duration}ms`;
        }
        
        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('idle', 'å¾…æ©Ÿä¸­');
        });
    </script>
</body>
</html>